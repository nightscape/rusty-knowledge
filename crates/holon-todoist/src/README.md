# Todoist Integration

A full-featured Todoist API v1 integration implementing the `DataSource<T>` trait from the holon architecture.

## Features

- ✅ Full CRUD operations (Create, Read, Update, Delete)
- ✅ Bearer token authentication
- ✅ Cursor-based pagination (200 items/page)
- ✅ Type-safe API client with `Send + Sync` error handling
- ✅ Automatic lens generation via `#[derive(Entity)]`
- ✅ QueryableCache integration for efficient queries
- ✅ In-memory caching with write-through to API
- ✅ Smart update handling (separate completion from property updates)
- ✅ Type converters for priority, datetime, and due strings

## Quick Start

### 1. Get your Todoist API token

1. Go to https://app.todoist.com/app/settings/integrations/developer
2. Copy your API token under "API token"
3. Set it as an environment variable:
   ```bash
   export TODOIST_API_KEY="your_api_token_here"
   ```

### 2. Basic Usage

```rust
use holon::integrations::todoist::{TodoistDataSource, TodoistTask};
use holon::core::queryable_cache::QueryableCache;
use holon::core::traits::{DataSource, Queryable};

#[tokio::main]
async fn main() {
    let api_key = std::env::var("TODOIST_API_KEY")
        .expect("TODOIST_API_KEY not set");

    // Create the data source
    let datasource = TodoistDataSource::new(&api_key);

    // Wrap in QueryableCache for efficient queries
    let cache = QueryableCache::with_database(datasource, ":memory:")
        .await
        .expect("Failed to create cache");

    // Sync all tasks from Todoist
    cache.sync().await.expect("Failed to sync");

    // Get all tasks
    let tasks = cache.get_all().await.expect("Failed to get tasks");
    println!("Total tasks: {}", tasks.len());
}
```

### 3. Querying Tasks

```rust
use holon::integrations::todoist::models::{CompletedLens, PriorityLens};
use holon::core::predicate::{Eq, Gt};

// Query incomplete tasks
let incomplete_predicate = Eq::new(CompletedLens, false);
let incomplete_tasks = cache.query(incomplete_predicate).await?;

// Query high-priority tasks (priority > 2)
let high_priority_pred = Gt::new(PriorityLens, 2);
let high_priority_tasks = cache.query(high_priority_pred).await?;

// Combine predicates
let high_priority_incomplete = Eq::new(CompletedLens, false)
    .and(Gt::new(PriorityLens, 2));
let tasks = cache.query(high_priority_incomplete).await?;
```

### 4. Creating and Updating Tasks

```rust
// Create a new task
let new_task = TodoistTask::new(
    String::new(), // ID will be generated by Todoist
    "My new task".to_string(),
    "project_id_here".to_string(),
);
let task_id = cache.insert(new_task).await?;

// Update a task
let mut task = cache.get_by_id(&task_id).await?.unwrap();
task.content = "Updated task title".to_string();
task.priority = 3; // High priority
task.description = Some("Updated description".to_string());
cache.update(&task_id, task).await?;

// Mark as complete
let mut task = cache.get_by_id(&task_id).await?.unwrap();
task.completed = true;
cache.update(&task_id, task).await?;

// Delete a task
cache.delete(&task_id).await?;
```

## Data Model

The `TodoistTask` struct includes:

| Field | Type | Description |
|-------|------|-------------|
| `id` | `String` | Unique task ID (generated by Todoist) |
| `content` | `String` | Task title/content |
| `description` | `Option<String>` | Task description |
| `project_id` | `String` | Parent project ID |
| `section_id` | `Option<String>` | Section within project |
| `parent_id` | `Option<String>` | Parent task for sub-tasks |
| `completed` | `bool` | Completion status |
| `priority` | `i32` | Priority (1=Normal, 2=Medium, 3=High, 4=Highest) |
| `due_date` | `Option<String>` | Due date (ISO 8601 or natural language) |
| `labels` | `Option<String>` | Comma-separated labels |
| `created_at` | `Option<String>` | Creation timestamp |
| `updated_at` | `Option<String>` | Last update timestamp |
| `completed_at` | `Option<String>` | Completion timestamp |
| `url` | `String` | Web URL to view task |

## Auto-Generated Lenses

The `TodoistTask` struct automatically generates type-safe lenses via `#[derive(Entity)]`:

- `IdLens`
- `ContentLens`
- `DescriptionLens`
- `ProjectIdLens`
- `SectionIdLens`
- `ParentIdLens`
- `CompletedLens`
- `PriorityLens`
- `DueDateLens`
- `LabelsLens`
- `CreatedAtLens`
- `UpdatedAtLens`
- `CompletedAtLens`
- `UrlLens`

## API Endpoints Covered

The `TodoistClient` implements:

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/tasks` | List all active tasks (paginated) |
| GET | `/tasks/{id}` | Get single task by ID |
| GET | `/tasks/completed` | List completed tasks (30-day window) |
| POST | `/tasks` | Create new task |
| POST | `/tasks/{id}` | Update task properties |
| POST | `/tasks/{id}/close` | Mark task as completed |
| POST | `/tasks/{id}/reopen` | Mark task as incomplete |
| DELETE | `/tasks/{id}` | Delete task |

## Type Converters

### Priority

Todoist uses integers 1-4 for priority:
- `1` → `Priority::Normal`
- `2` → `Priority::Medium`
- `3` → `Priority::High`
- `4` → `Priority::Highest`

### DateTime

Supports multiple formats:
- `YYYY-MM-DD` (date only, defaults to 00:00:00 UTC)
- `YYYY-MM-DDTHH:MM:SS.fff` (with milliseconds)
- RFC 3339 / ISO 8601 with timezone

### Due Strings

Natural language date strings:
- `"today"` - Today's date
- `"tomorrow"` - Tomorrow
- `"weekend"` - Coming weekend
- `"next week"` - Next Monday
- `"no date"` - Remove due date
- `"YYYY-MM-DD"` - Custom date

## Testing

The integration includes comprehensive tests:

### Unit Tests

```bash
cargo test -p holon integrations::todoist
```

### Integration Tests (Require API Key)

Set up environment variables:
```bash
export TODOIST_API_KEY="your_api_token"
export TODOIST_TEST_PROJECT_ID="your_test_project_id"
```

Run ignored tests:
```bash
cargo test -p holon todoist_integration -- --ignored
```

## Architecture

```
TodoistDataSource
    ├── TodoistClient (HTTP API)
    │   ├── Bearer token auth
    │   ├── Cursor pagination
    │   └── 9 API endpoints
    ├── In-memory cache (HashMap)
    └── implements DataSource<TodoistTask>
        ├── get_all()
        ├── get_by_id()
        ├── insert()
        ├── update()
        └── delete()

Wrapped by QueryableCache<TodoistDataSource, TodoistTask>
    ├── SQLite cache layer
    ├── Implements Queryable<TodoistTask>
    └── Supports predicate-based queries
```

## Performance

- **Pagination:** Fetches 200 tasks per request
- **Caching:** In-memory cache + optional SQLite cache via QueryableCache
- **Sync:** Only syncs when cache is empty or explicitly requested
- **Updates:** Smart detection - only sends changed fields to API

## Limitations

- Currently uses static API key (no OAuth2)
- No webhook support (polling only)
- 30-day window for completed tasks
- No offline queue for failed operations
- No rate limiting protection

## Future Enhancements

- [ ] OAuth2 authentication flow
- [ ] Webhook support for real-time updates
- [ ] Offline operation queue
- [ ] Rate limiting with exponential backoff
- [ ] Project and section management
- [ ] Label management
- [ ] Attachment support
- [ ] Comment support

## References

- [Todoist REST API Documentation](https://developer.todoist.com/rest/v2/)
- [holon architecture2.md](../../../../../../docs/architecture2.md)
- [Example usage](../../../examples/todoist_integration.rs)
